package com.tp.controller;

import java.util.ArrayList;
import java.util.List;

import javax.servlet.http.HttpSession;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Required;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.Random;

import com.tp.entity.Cart;
import com.tp.entity.Menu;
import com.tp.entity.MenuOrder;
import com.tp.entity.UserEntity;
import com.tp.service.CartService;
import com.tp.service.MenuOrderService;
import com.tp.service.UserService;

@Controller
public class PayController {
	
	@Autowired
	UserService userService;
	
	@Autowired 
	CartService cartService;
	
	@Autowired
	MenuOrderService menuOrderService;

	@PostMapping("/cart")
	public String cart(HttpSession session,
			@RequestParam(value = "QuantitySum", required = false) Integer totalQuantity,
			@RequestParam(value = "PriceSum", required = false) Integer PriceSum, RedirectAttributes rttr) {
		if(totalQuantity== null || PriceSum == null) {
			rttr.addFlashAttribute("result", "NO");
			return "redirect:/nocart";
		}else {
			String username=(String)session.getAttribute("username");
			if(username!=null) {
				UserEntity userinfo = userService.UserInfo(username);
				session.setAttribute("user", userinfo);
				session.setAttribute("uuid", userinfo.getId());
				session.setAttribute("name", userinfo.getName());
				session.setAttribute("email", userinfo.getEmail());
				
				 // 현재 날짜 및 시간 가져오기
		        Date now = new Date();

		        // 주문번호 형식을 위한 날짜 및 시간 포맷 지정
		        SimpleDateFormat dateFormat = new SimpleDateFormat("yyyyMMddHHmmss");

		        // 주문번호 생성을 위한 랜덤 숫자 생성
		        Random random = new Random();
		        int randomNumber = random.nextInt(900) + 100; // 세 자리 랜덤 숫자 (100 이상 999 이하)

		        // 주문번호 조합
		        String orderNumber = dateFormat.format(now) + randomNumber;
		        
		        session.setAttribute("orderNumber", orderNumber);

//				cartService.deleteCartByUser(userinfo);

				return "/pay/cart";
			}else {
				return "redirect:/sessionover";
			}	
		}
		
		
	}
	
	@PostMapping("/cart2")
	public String cart2(HttpSession session,
			@RequestParam("priceAll") Integer priceAll) {
		 
			String username=(String)session.getAttribute("username");
			if(username!=null) {
				UserEntity userinfo = userService.UserInfo(username);
				session.setAttribute("user", userinfo);
				session.setAttribute("uuid", userinfo.getId());
				session.setAttribute("name", userinfo.getName());
				session.setAttribute("email", userinfo.getEmail());
				
				 // 현재 날짜 및 시간 가져오기
		        Date now = new Date();

		        // 주문번호 형식을 위한 날짜 및 시간 포맷 지정
		        SimpleDateFormat dateFormat = new SimpleDateFormat("yyyyMMddHHmmss");

		        // 주문번호 생성을 위한 랜덤 숫자 생성
		        Random random = new Random();
		        int randomNumber = random.nextInt(900) + 100; // 세 자리 랜덤 숫자 (100 이상 999 이하)

		        // 주문번호 조합
		        String orderNumber = dateFormat.format(now) + randomNumber;
		        
		        session.setAttribute("orderNumber", orderNumber);
				
				return "/pay/cart";
			}else {
				return "redirect:/sessionover";
			}	
		
		
		
	}
	
	@GetMapping("/success")
	public String success(
	    MenuOrder menuOrder,
	    Menu menu,
	    UserEntity user,
	    Cart cart,
	    HttpSession session,
	    Model model
	) {
	    String username = (String) session.getAttribute("username");

	    user = userService.UserInfo(username);
	    
	    List<UserEntity> userList = new ArrayList<>();
		userList.add(user);
	    
	    String userId = user.getId();
	    
	    List<Cart> savedCart = cartService.findCart(user);

//	    Cart savedCart = cartService.findCartByUserId(userId);

	    System.out.println("savedCart : " + savedCart);
	    
	    for(int i = 0; i<savedCart.size(); i++) {
	    	menuOrder.setQuantity(savedCart.get(i).getQuantity());
	    	menuOrder.setCart(savedCart.get(i));
	    	menuOrder.setMenu(savedCart.get(i).getMenu());
	    	menuOrder.setUser(userList);
	    	
	    	menuOrderService.saveOrder(menuOrder);
	    	
		    List<MenuOrder> menuOrderList = new ArrayList<>();
		    menuOrderList.add(menuOrder);
		    
		    System.out.println("출력 1" + savedCart.get(i).getQuantity());
		    System.out.println("출력 2" + savedCart.get(i).getMenu());
		    System.out.println("출력 3" + savedCart.get(i).getMenu().getId());
	    	
	    }
	    
//	    menuOrder.setQuantity(savedCart.getQuantity());
//	    menuOrder.setCartId(savedCart.getId());
//	    menuOrder.setMenu(savedCart.getMenu());
//	    menuOrder.setUser(userList);
//	    

	    
	    

//	    model.addAttribute("menuOrderList", menuOrderList);
//	    
//	    System.out.println("menuOrderList : " + menuOrderList);
	    
	    System.out.println("menuOrder : " + menuOrder);
	    
	    UserEntity userinfo = userService.UserInfo(username);
	    
	    cartService.deleteCartByUser(userinfo);

	    return "redirect:/MyOrder";
	}

	
	@GetMapping("/nocart")
	public String nocart() {
		return "/pay/nocart";
	}
	

	
//	@RequestMapping("/success")
//	public String success(
//			MenuOrder menuOrder,
//			Menu menu,
//			UserEntity user,
//			Cart cart,
//			HttpSession session
//			) {
//		
//		String username = (String)session.getAttribute("username");
//		
//		user = userService.UserInfo(username);
//		
////		menuOrder = MenuOrder.builder()			
////				.cart(cart)
////				.user(user)
////				.menu(menu)
////				.build();
//		
//		return "/pay/success";
//	}
	
//	@GetMapping("/success")
//	public String success() {
//		return "/pay/success";
//	}

	@PostMapping("/success")
	public String successs() {
		return "/pay/success";
	}
	
	
	@GetMapping("/fail")
	public String fail() {
		return "/pay/fail";
	}
	@PostMapping("/fail")
	public String faill() {
		return "/pay/fail";
	}
}

